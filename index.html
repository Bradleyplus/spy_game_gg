
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Undercover - Web Spy Game</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;900&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #020617;
            color: #f8fafc;
            margin: 0;
            overflow-x: hidden;
            min-height: 100vh;
        }
        .glass-card {
            background: rgba(30, 41, 59, 0.6);
            backdrop-filter: blur(16px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        .perspective-1000 { perspective: 1000px; }
        .preserve-3d { transform-style: preserve-3d; }
        .backface-hidden { backface-visibility: hidden; }
        .rotate-y-180 { transform: rotateY(180deg); }
        .card-inner {
            transition: transform 0.8s cubic-bezier(0.4, 0, 0.2, 1);
            transform-style: preserve-3d;
        }
        .card-flipped { transform: rotateY(180deg); }
        
        /* Custom scrollbar */
        ::-webkit-scrollbar { width: 4px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: rgba(255, 255, 255, 0.1); border-radius: 10px; }

        @keyframes pulse-indigo {
            0%, 100% { border-color: rgba(99, 102, 241, 0.3); }
            50% { border-color: rgba(99, 102, 241, 0.8); }
        }
        .animate-pulse-indigo { animation: pulse-indigo 2s infinite; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
    </style>
<script type="importmap">
{
  "imports": {
    "@google/genai": "https://esm.sh/@google/genai@^1.34.0",
    "react/": "https://esm.sh/react@^19.2.3/",
    "react": "https://esm.sh/react@^19.2.3",
    "react-dom/": "https://esm.sh/react-dom@^19.2.3/"
  }
}
</script>
</head>
<body>
    <div id="app" class="min-h-screen flex flex-col items-center justify-center p-4">
        <div class="text-indigo-400 font-bold animate-pulse">Initializing Systems...</div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
        import { getDatabase, ref, set, update, onValue, get, remove } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-database.js";
        import { GoogleGenAI, Type } from "https://esm.sh/@google/genai@^1.34.0";

        // --- Configuration ---
        // 注意：如果运行报错，请尝试将 databaseURL 改为 "https://spy-game-01.firebaseio.com"
        const firebaseConfig = {
            apiKey: "AIzaSyDVVVUN5OqatqjSrvLwU3tLJXLKbZMW1bA",
            authDomain: "spy-game-01.firebaseapp.com",
            databaseURL: "https://spy-game-01-default-rtdb.firebaseio.com", 
            projectId: "spy-game-01",
            storageBucket: "spy-game-01.firebasestorage.app",
            messagingSenderId: "316027229274",
            appId: "1:316027229274:web:7e7a71258cc8b9c9a87463"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        // --- Constants ---
        const FALLBACK_PAIRS = [
            { civilian: "Apple", spy: "Pear" },
            { civilian: "Mountain", spy: "Hill" },
            { civilian: "Coffee", spy: "Tea" },
            { civilian: "Pen", spy: "Pencil" },
            { civilian: "Milk", spy: "Yogurt" },
            { civilian: "Sun", spy: "Moon" },
            { civilian: "Doctor", spy: "Nurse" }
        ];

        // --- State Management ---
        let state = {
            user: JSON.parse(localStorage.getItem('spy_user') || 'null'),
            room: null,
            loading: false,
            generatingAvatar: false,
            isRevealed: false,
            selectedAvatar: "https://api.dicebear.com/7.x/bottts-neutral/svg?seed=Felix"
        };

        const PREDEFINED_AVATARS = [
            "https://api.dicebear.com/7.x/bottts-neutral/svg?seed=Felix",
            "https://api.dicebear.com/7.x/bottts-neutral/svg?seed=Luna",
            "https://api.dicebear.com/7.x/bottts-neutral/svg?seed=Buster",
            "https://api.dicebear.com/7.x/bottts-neutral/svg?seed=Milo",
        ];

        const BOT_NAMES = ["Agent Alpha", "Cipher Beta", "Ghost Gamma", "Shadow Delta", "Echo Epsilon", "Rogue Zeta", "Spectre Eta"];

        // --- Helper Functions ---
        function cleanJson(text) {
            if (!text) return "";
            return text.replace(/```json/g, "").replace(/```/g, "").trim();
        }

        function getApiKey() {
            try {
                return (typeof process !== 'undefined' && process.env?.API_KEY) || window.process?.env?.API_KEY || "";
            } catch(e) { return ""; }
        }

        // --- Core Functions ---
        async function generateAIAvatar(name) {
            if (!name) return alert("Enter nickname first!");
            const key = getApiKey();
            if (!key) return; // Silent skip if no key
            
            state.generatingAvatar = true;
            render();
            try {
                const ai = new GoogleGenAI({ apiKey: key });
                const response = await ai.models.generateContent({
                    model: 'gemini-2.5-flash-image',
                    contents: {
                        parts: [{ text: `A professional, minimalist, sleek spy profile icon for a character named '${name}'. Cyberpunk noir aesthetic.` }]
                    }
                });

                for (const part of response.candidates[0].content.parts) {
                    if (part.inlineData) {
                        state.selectedAvatar = `data:${part.inlineData.mimeType};base64,${part.inlineData.data}`;
                        break;
                    }
                }
            } catch (e) {
                console.warn("Avatar Gen failed, ignoring.");
            } finally {
                state.generatingAvatar = false;
                render();
            }
        }

        function login(name) {
            const user = {
                id: 'u_' + Math.random().toString(36).substr(2, 9),
                name: name.trim(),
                avatar: state.selectedAvatar
            };
            localStorage.setItem('spy_user', JSON.stringify(user));
            state.user = user;
            render();
        }

        async function createRoom() {
            state.loading = true;
            render();
            const roomId = Math.floor(1000 + Math.random() * 9000).toString();
            const newRoom = {
                id: roomId,
                status: 'waiting',
                phase: 'discussion',
                players: {
                    [state.user.id]: {
                        id: state.user.id,
                        name: state.user.name,
                        avatar: state.user.avatar,
                        isHost: true,
                        isAlive: true,
                        votedFor: null,
                        seatIndex: 0
                    }
                }
            };
            try {
                await set(ref(db, `rooms/${roomId}`), newRoom);
                listenToRoom(roomId);
            } catch (e) {
                console.error("Firebase Create Failed:", e);
                alert("Database Error: " + e.message + "\nCheck if Firebase rules allow read/write.");
                state.loading = false;
                render();
            }
        }

        async function joinRoom(roomId) {
            state.loading = true;
            render();
            try {
                const snapshot = await get(ref(db, `rooms/${roomId}`));
                if (!snapshot.exists()) {
                    alert("Room not found!");
                    state.loading = false;
                    render();
                    return;
                }
                const data = snapshot.val();
                const playersList = Object.values(data.players || {});
                if (playersList.length >= 7) {
                    alert("Room full!");
                    state.loading = false;
                    render();
                    return;
                }

                const takenSeats = playersList.map(p => p.seatIndex);
                let seatIndex = 0;
                for (let i = 0; i < 7; i++) {
                    if (!takenSeats.includes(i)) {
                        seatIndex = i;
                        break;
                    }
                }

                await update(ref(db, `rooms/${roomId}/players/${state.user.id}`), {
                    id: state.user.id,
                    name: state.user.name,
                    avatar: state.user.avatar,
                    isHost: false,
                    isAlive: true,
                    votedFor: null,
                    seatIndex: seatIndex
                });
                listenToRoom(roomId);
            } catch (e) {
                console.error("Firebase Join Failed:", e);
                alert("Join Error: " + e.message);
                state.loading = false;
                render();
            }
        }

        function listenToRoom(roomId) {
            onValue(ref(db, `rooms/${roomId}`), (snapshot) => {
                const data = snapshot.val();
                if (data) {
                    if (state.user && (!data.players || !data.players[state.user.id])) {
                        state.room = null;
                        alert("Session Expired: You were removed from this room.");
                        render();
                        return;
                    }
                    state.room = data;
                    state.loading = false;
                    render();
                } else {
                    state.room = null;
                    render();
                }
            }, (error) => {
                console.error("Sync Error:", error);
            });
        }

        async function addBot() {
            if (!state.room || Object.keys(state.room.players).length >= 7) return;
            const botId = 'bot_' + Math.random().toString(36).substr(2, 9);
            const botName = BOT_NAMES[Math.floor(Math.random() * BOT_NAMES.length)];
            const botAvatar = `https://api.dicebear.com/7.x/bottts-neutral/svg?seed=${botId}`;
            
            const playersList = Object.values(state.room.players || {});
            const takenSeats = playersList.map(p => p.seatIndex);
            let seatIndex = 0;
            for (let i = 0; i < 7; i++) {
                if (!takenSeats.includes(i)) {
                    seatIndex = i;
                    break;
                }
            }

            await update(ref(db, `rooms/${state.room.id}/players/${botId}`), {
                id: botId,
                name: botName,
                avatar: botAvatar,
                isHost: false,
                isAlive: true,
                isBot: true,
                votedFor: null,
                seatIndex: seatIndex
            });
        }

        async function startGame() {
            const players = Object.values(state.room.players);
            if (players.length < 3) return alert("Need at least 3 players!");

            state.loading = true;
            render();

            let pair = null;
            const apiKey = getApiKey();
            
            if (apiKey) {
                try {
                    const ai = new GoogleGenAI({ apiKey: apiKey });
                    const response = await ai.models.generateContent({
                        model: "gemini-3-flash-preview",
                        contents: "Generate 1 pair of simple nouns for 'Who is the Spy'. Output JSON only: [{'civilian': '...', 'spy': '...'}]",
                        config: { responseMimeType: "application/json" }
                    });
                    const parsed = JSON.parse(cleanJson(response.text));
                    pair = Array.isArray(parsed) ? parsed[0] : parsed;
                } catch (e) {
                    console.warn("AI Word Gen failed, using internal dictionary.");
                }
            }

            if (!pair || !pair.civilian) {
                pair = FALLBACK_PAIRS[Math.floor(Math.random() * FALLBACK_PAIRS.length)];
            }

            try {
                const shuffled = [...players].sort(() => Math.random() - 0.5);
                const spyId = shuffled[0].id;
                const blankId = (shuffled.length === 7) ? shuffled[1].id : null;

                const updates = {};
                players.forEach(p => {
                    let role = 'civilian';
                    let word = pair.civilian;
                    if (p.id === spyId) { role = 'spy'; word = pair.spy; }
                    else if (p.id === blankId) { role = 'blank'; word = "BLANK"; }
                    
                    updates[`rooms/${state.room.id}/players/${p.id}/role`] = role;
                    updates[`rooms/${state.room.id}/players/${p.id}/word`] = word;
                    updates[`rooms/${state.room.id}/players/${p.id}/isAlive`] = true;
                    updates[`rooms/${state.room.id}/players/${p.id}/votedFor`] = null;
                });

                updates[`rooms/${state.room.id}/status`] = 'playing';
                updates[`rooms/${state.room.id}/phase`] = 'discussion';
                updates[`rooms/${state.room.id}/winner`] = null;
                updates[`rooms/${state.room.id}/discussionEndTime`] = Date.now() + 180000;

                await update(ref(db), updates);
            } catch (e) {
                console.error("Game Start Write Failed:", e);
                alert("Critical System Failure: Could not broadcast start signal to Firebase.");
            } finally {
                state.loading = false;
                render();
            }
        }

        async function castVote(targetId) {
            await update(ref(db, `rooms/${state.room.id}/players/${state.user.id}`), { votedFor: targetId });
        }

        async function resolveVoting() {
            const players = Object.values(state.room.players);
            const votes = {};
            players.forEach(p => { if (p.votedFor) votes[p.votedFor] = (votes[p.votedFor] || 0) + 1; });

            let max = -1, eliminatedId = null, tie = false;
            Object.entries(votes).forEach(([id, count]) => {
                if (count > max) { max = count; eliminatedId = id; tie = false; }
                else if (count === max) { tie = true; }
            });

            if (tie || !eliminatedId) {
                const resets = {};
                players.forEach(p => resets[`rooms/${state.room.id}/players/${p.id}/votedFor`] = null);
                resets[`rooms/${state.room.id}/phase`] = 'discussion';
                resets[`rooms/${state.room.id}/discussionEndTime`] = Date.now() + 180000;
                return update(ref(db), resets);
            }

            const updates = {};
            updates[`rooms/${state.room.id}/players/${eliminatedId}/isAlive`] = false;
            players.forEach(p => updates[`rooms/${state.room.id}/players/${p.id}/votedFor`] = null);

            const survivors = players.map(p => p.id === eliminatedId ? { ...p, isAlive: false } : p);
            const spies = survivors.filter(p => p.isAlive && (p.role === 'spy' || p.role === 'blank')).length;
            const civilians = survivors.filter(p => p.isAlive && p.role === 'civilian').length;

            let winner = null;
            if (spies === 0) winner = 'civilians';
            else if (civilians <= spies) winner = 'spies';

            updates[`rooms/${state.room.id}/phase`] = winner ? 'game_over' : 'elimination';
            updates[`rooms/${state.room.id}/winner`] = winner;
            updates[`rooms/${state.room.id}/eliminatedPlayerId`] = eliminatedId;

            await update(ref(db), updates);
        }

        // --- Render System ---
        function render() {
            const appDiv = document.getElementById('app');
            if (!state.user) return renderLobby(appDiv);
            if (!state.room) return renderJoinCreate(appDiv);
            if (state.room.status === 'waiting' || !state.room.status) return renderWaitingRoom(appDiv);
            return renderGameRoom(appDiv);
        }

        function renderLobby(container) {
            container.innerHTML = `
                <div class="w-full max-w-sm flex flex-col items-center">
                    <h1 class="text-6xl font-black mb-12 tracking-tighter text-transparent bg-clip-text bg-gradient-to-br from-indigo-400 to-purple-500 uppercase">Undercover</h1>
                    <div class="glass-card w-full p-8 rounded-[2.5rem] shadow-2xl space-y-8">
                        <div>
                            <label class="block text-[10px] font-black text-slate-500 uppercase mb-3 ml-1">Agent Handle</label>
                            <input id="nameInput" type="text" placeholder="Identity name..." class="w-full bg-slate-900/50 border border-slate-800 rounded-2xl px-5 py-4 text-white focus:outline-none focus:ring-2 focus:ring-indigo-500 font-bold">
                        </div>
                        <div class="grid grid-cols-4 gap-2">
                            ${PREDEFINED_AVATARS.map(url => `
                                <div onclick="window.selectAvatar('${url}')" class="relative aspect-square rounded-xl overflow-hidden border-2 cursor-pointer ${state.selectedAvatar === url ? 'border-indigo-500 scale-105' : 'border-slate-800 opacity-60'}">
                                    <img src="${url}" class="w-full h-full object-cover">
                                </div>
                            `).join('')}
                            <div onclick="window.triggerAIGen()" class="relative aspect-square rounded-xl border-2 border-dashed border-slate-800 flex items-center justify-center cursor-pointer ${state.generatingAvatar ? 'animate-pulse' : ''}">
                                ${state.selectedAvatar.startsWith('data:') ? `<img src="${state.selectedAvatar}" class="w-full h-full object-cover rounded-lg">` : `<span class="text-[8px] font-black text-indigo-400">AI GEN</span>`}
                            </div>
                        </div>
                        <button onclick="window.doLogin()" class="w-full py-5 bg-indigo-600 hover:bg-indigo-500 text-white rounded-2xl font-black text-lg shadow-xl">COMMENCE MISSION</button>
                    </div>
                </div>
            `;
        }

        function renderJoinCreate(container) {
            container.innerHTML = `
                <div class="w-full max-w-sm flex flex-col items-center">
                    <div class="text-center mb-12 flex flex-col items-center">
                        <div class="w-24 h-24 rounded-[2rem] border-2 border-indigo-500/30 overflow-hidden mb-4 shadow-2xl"><img src="${state.user.avatar}" class="w-full h-full object-cover"></div>
                        <p class="text-3xl font-black text-white">${state.user.name}</p>
                    </div>
                    <div class="w-full space-y-4">
                        <button onclick="window.createRoom()" class="w-full py-6 bg-indigo-600 hover:bg-indigo-500 text-white rounded-[2rem] font-black text-xl shadow-xl">NEW SECTOR</button>
                        <div class="flex gap-2">
                            <input id="roomInput" type="number" placeholder="4-digit ID" class="flex-1 bg-slate-900/50 border border-slate-800 rounded-2xl px-5 py-4 text-center text-xl text-white font-mono">
                            <button onclick="window.doJoin()" class="px-8 bg-slate-800 hover:bg-slate-700 text-white rounded-2xl font-black">JOIN</button>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderWaitingRoom(container) {
            const playersList = Object.values(state.room.players || {});
            const me = state.room.players[state.user.id];
            const isHost = me?.isHost;

            container.innerHTML = `
                <div class="w-full max-w-2xl">
                    <div class="flex flex-col md:flex-row justify-between items-center mb-10 gap-6">
                        <div class="text-center md:text-left">
                            <h2 class="text-xs font-black text-indigo-400 uppercase tracking-widest mb-2">Sector ID</h2>
                            <p class="text-6xl font-mono font-black text-white">${state.room.id}</p>
                        </div>
                        <div class="text-2xl font-black text-white bg-slate-900/50 px-6 py-2 rounded-full border border-slate-800">${playersList.length} / 7 Locked</div>
                    </div>

                    <div class="grid grid-cols-2 sm:grid-cols-4 gap-4 mb-12">
                        ${playersList.map(p => `
                            <div class="relative glass-card rounded-[2rem] p-6 border-2 flex flex-col items-center border-slate-800">
                                <img src="${p.avatar}" class="w-16 h-16 rounded-2xl mb-3 border-2 border-slate-700">
                                <span class="text-[10px] font-black uppercase text-center">${p.name} ${p.isBot ? '(BOT)' : ''}</span>
                                ${isHost && p.id !== state.user.id ? `<button onclick="window.kickPlayer('${p.id}')" class="absolute -top-2 -right-2 bg-rose-600 text-white text-[8px] font-black px-2 py-1 rounded-full">KICK</button>` : ''}
                            </div>
                        `).join('')}
                    </div>

                    ${isHost ? `
                        <div class="flex gap-4">
                            <button onclick="window.addBot()" class="flex-1 py-5 bg-slate-800 text-white rounded-[2rem] font-black">ADD BOT</button>
                            <button onclick="window.startGame()" ${playersList.length < 3 ? 'disabled opacity-50' : ''} class="flex-[2] py-5 bg-indigo-600 text-white rounded-[2rem] font-black text-2xl">
                                ${state.loading ? 'INITIATING...' : 'BEGIN OPERATION'}
                            </button>
                        </div>
                    ` : `<div class="w-full py-5 text-center text-slate-500 font-black animate-pulse">WAITING FOR DIRECTOR...</div>`}
                    <button onclick="window.leaveRoom()" class="w-full mt-6 text-xs font-black text-slate-600 hover:text-rose-500 uppercase">Abort Assignment</button>
                </div>
            `;
        }

        function renderGameRoom(container) {
            const me = state.room.players[state.user.id];
            const players = Object.values(state.room.players);
            const isHost = me?.isHost;

            let content = '';
            if (state.room.phase === 'discussion') {
                const timeLeft = Math.max(0, Math.floor((state.room.discussionEndTime - Date.now()) / 1000));
                content = `
                    <div class="flex flex-col items-center">
                        <div class="mb-10 text-6xl font-mono font-black ${timeLeft < 30 ? 'text-rose-500 animate-pulse' : 'text-white'}">${Math.floor(timeLeft/60)}:${String(timeLeft%60).padStart(2,'0')}</div>
                        <div onclick="window.toggleReveal()" class="relative w-64 h-96 perspective-1000 cursor-pointer">
                            <div class="card-inner w-full h-full preserve-3d ${state.isRevealed ? 'card-flipped' : ''}">
                                <div class="absolute inset-0 backface-hidden glass-card rounded-[3rem] border-4 border-indigo-500/20 flex flex-col items-center justify-center p-8">
                                    <p class="text-xl font-black text-indigo-400">DECRYPT INTEL</p>
                                    <p class="text-[10px] text-slate-600 mt-2 uppercase">Tap to reveal</p>
                                </div>
                                <div class="absolute inset-0 backface-hidden rotate-y-180 bg-indigo-600 rounded-[3rem] flex flex-col items-center justify-center p-8 text-center">
                                    <h3 class="text-2xl font-black text-white mb-6 uppercase">${me.role}</h3>
                                    <p class="text-5xl font-black text-white">${me.word}</p>
                                </div>
                            </div>
                        </div>
                        ${isHost ? `<button onclick="window.startVoting()" class="mt-12 px-12 py-5 bg-indigo-600 rounded-2xl font-black text-lg">FORCE VOTE</button>` : ''}
                    </div>
                `;
            } else if (state.room.phase === 'voting') {
                const alive = players.filter(p => p.isAlive);
                content = `
                    <div class="w-full max-w-md">
                        <h2 class="text-4xl font-black text-center mb-10 text-white uppercase">VOTING</h2>
                        <div class="space-y-4">
                            ${alive.map(p => `
                                <button onclick="window.doVote('${p.id}')" ${me.votedFor || !me.isAlive ? 'disabled' : ''} class="w-full flex items-center justify-between p-4 rounded-3xl border-2 ${me.votedFor === p.id ? 'bg-indigo-600 border-indigo-400' : 'bg-slate-900/50 border-slate-800'}">
                                    <span class="font-black text-xl text-white uppercase">${p.name}</span>
                                    ${p.votedFor ? `<span class="bg-indigo-400/20 text-indigo-300 text-[8px] font-bold px-2 py-1 rounded-full uppercase">LOCKED</span>` : ''}
                                </button>
                            `).join('')}
                        </div>
                        ${isHost ? `<button onclick="window.resolveVoting()" class="w-full mt-12 py-6 bg-rose-600 rounded-[2rem] font-black text-xl">RESOLVE</button>` : ''}
                    </div>
                `;
            } else if (state.room.phase === 'elimination' || state.room.phase === 'game_over') {
                const winnerText = state.room.winner ? `${state.room.winner.toUpperCase()} VICTORIOUS` : "MISSION SUSPENDED";
                content = `
                    <div class="text-center">
                        <h1 class="text-7xl font-black mb-6 text-indigo-500">OP END</h1>
                        <h2 class="text-3xl font-black text-white mb-16">${winnerText}</h2>
                        ${isHost ? `<button onclick="window.resetRoom()" class="w-full py-6 bg-indigo-600 rounded-[2rem] font-black text-2xl">NEW OP</button>` : ''}
                    </div>
                `;
            }

            container.innerHTML = `
                <div class="w-full min-h-screen flex flex-col py-8">
                    <div class="flex-1 flex flex-col justify-center items-center">${content}</div>
                </div>
            `;
        }

        // --- Event Listeners ---
        window.selectAvatar = (url) => { state.selectedAvatar = url; render(); };
        window.triggerAIGen = () => generateAIAvatar(document.getElementById('nameInput')?.value);
        window.doLogin = () => login(document.getElementById('nameInput')?.value);
        window.doJoin = () => joinRoom(document.getElementById('roomInput')?.value);
        window.createRoom = createRoom;
        window.startGame = startGame;
        window.addBot = addBot;
        window.kickPlayer = kickPlayer;
        window.toggleReveal = () => { state.isRevealed = !state.isRevealed; render(); };
        window.startVoting = () => update(ref(db, `rooms/${state.room.id}`), { phase: 'voting' });
        window.doVote = castVote;
        window.resolveVoting = resolveVoting;
        window.nextRound = () => update(ref(db, `rooms/${state.room.id}`), { phase: 'discussion', discussionEndTime: Date.now() + 180000 });
        window.resetRoom = async () => {
            const updates = {
                [`rooms/${state.room.id}/status`]: 'waiting',
                [`rooms/${state.room.id}/phase`]: 'discussion',
                [`rooms/${state.room.id}/winner`]: null,
                [`rooms/${state.room.id}/eliminatedPlayerId`]: null
            };
            Object.values(state.room.players).forEach(p => {
                updates[`rooms/${state.room.id}/players/${p.id}/isAlive`] = true;
                updates[`rooms/${state.room.id}/players/${p.id}/votedFor`] = null;
                updates[`rooms/${state.room.id}/players/${p.id}/role`] = null;
                updates[`rooms/${state.room.id}/players/${p.id}/word`] = null;
            });
            await update(ref(db), updates);
        };
        window.leaveRoom = async () => {
            if (state.room && state.user) {
                const players = Object.values(state.room.players);
                if (players.length <= 1) await remove(ref(db, `rooms/${state.room.id}`));
                else await remove(ref(db, `rooms/${state.room.id}/players/${state.user.id}`));
            }
            state.room = null;
            render();
        };

        setInterval(() => { if (state.room?.phase === 'discussion') render(); }, 1000);
        render();

        setInterval(async () => {
            if (state.room?.status === 'playing' && state.room?.phase === 'discussion' && state.room.players[state.user.id]?.isHost) {
                if (Date.now() >= (state.room.discussionEndTime || 0)) {
                    await update(ref(db, `rooms/${state.room.id}`), { phase: 'voting' });
                }
            }
        }, 3000);
    </script>
</body>
</html>
